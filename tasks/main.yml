---

- name: query linux kernel architecture
  shell: echo "$(uname -s)-$(uname -p)"
  register: kernel_arch

- name: query linux kernel release
  shell: uname -r | xargs
  register: kernel_release 

- name: query debian distro
  shell: lsb_release -i | cut -d':' -f 2 | awk '{print tolower($0)}' | xargs
  register: debian_distro

- name: query debian release
  shell: lsb_release -c | cut -d':' -f 2 | awk '{print tolower($0)}' | xargs
  register: debian_release

- name: install apt-transport-https 
  apt: name=apt-transport-https state=present update_cache=yes cache_valid_time=3600

- name: install ca-certificates
  apt: name=ca-certificates state=present update_cache=yes cache_valid_time=3600

- name: install docker gpg key
  shell: gpg --list-keys {{ docker_gpg_key}} || apt-key adv --keyserver {{ docker_gpg_server }} --recv-keys {{ docker_gpg_key }}

- name: register apt sources (ubuntu)
  shell: echo "deb https://apt.dockerproject.org/repo ubuntu-{{ debian_release.stdout }} main" > /etc/apt/sources.list.d/docker.list
  when: debian_distro.stdout == "ubuntu"

- name: register apt sources (debian)
  shell: echo "deb https://apt.dockerproject.org/repo debian-{{ debian_release.stdout }} main" > /etc/apt/sources.list.d/docker.list
  when: debian_distro.stdout == "debian"

- name: purge lxc-docker
  apt: name=lxc-docker state=absent purge=yes

- name: install linux-image-extra
  apt: name=linux-image-extra-{{ kernel_release.stdout }} state=present
  when: debian_distro.stdout == "ubuntu"

- name: install docker-engine
  apt: name=docker-engine state=present update_cache=yes cache_valid_time=3600

- name: docker group
  group:
    name: docker
    state: present
    system: yes

- name: enable docker service
  service:
    name: docker
    enabled: yes

- name: start docker
  service:
    name: docker
    state: started

- name: query docker-compose binary path
  shell: which docker-compose
  register: docker_compose_path
  ignore_errors: True

- name: install docker-compose if not present
  when: docker_compose_path.rc == 1
  get_url:
    url: https://github.com/docker/compose/releases/download/{{ docker_compose_version}}/docker-compose-{{ kernel_arch.stdout }}
    dest: /usr/local/bin/docker-compose
    mode: 0755

